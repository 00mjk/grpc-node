name: Binary build

on:
  push:
    branches:
      - 'grpc@1.24.x'
  pull_request:
    branches:
      - 'grpc@1.24.x'

jobs:
  linux_nodejs_native:
    name: Linux Node native build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Build
      run: |
        docker build -t kokoro-native-image tools/release/native
        docker run -v /var/run/docker.sock:/var/run/docker.sock -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE -e ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts -e JOBS=8 kokoro-native-image $GITHUB_WORKSPACE/packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_node.sh
    - uses: actions/upload-artifact@v2
      with:
        name: linux-nodejs-native
        path: artifacts/
  linux_nodejs_alpine:
    name: Linux Node Alpine build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Build
      run: |
        docker build -t kokoro-alpine-image packages/grpc-native-core/tools/docker/alpine_artifact
        docker run -v /var/run/docker.sock:/var/run/docker.sock -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE -e ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts -e JOBS=8 kokoro-alpine-image $GITHUB_WORKSPACE/packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_node.sh --with-alpine
    - uses: actions/upload-artifact@v2
      with:
        name: linux-nodejs-alpine
        path: artifacts/
  linux_nodejs_arm:
    name: Linux Node ARM build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Build
      run: |
        docker build -t kokoro-cross-image tools/release/cross
        docker run -v /var/run/docker.sock:/var/run/docker.sock -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE -e ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts -e JOBS=8 kokoro-cross-image $GITHUB_WORKSPACE/packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_node_arm.sh
    - uses: actions/upload-artifact@v2
      with:
        name: linux-nodejs-arm
        path: artifacts/
  linux_electron:
    name: Linux Electron build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Build
      run: |
        docker build -t kokoro-native-image tools/release/native
        docker run -v /var/run/docker.sock:/var/run/docker.sock -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE -e ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts -e JOBS=8 kokoro-native-image $GITHUB_WORKSPACE/packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_electron.sh
    - uses: actions/upload-artifact@v2
      with:
        name: linux-electron
        path: artifacts/
  macos_nodejs:
    name: Macos Node build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-node@v1
      with:
        node-version: '12'
    - name: Setup npm environment
      run: |
        npm install -g npm
        # https://github.com/mapbox/node-pre-gyp/issues/362
        npm install -g node-gyp@3
    - name: Build
      env:
        JOBS: '8'
      run: |
        export ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts
        packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_node.sh
    - uses: actions/upload-artifact@v2
      with:
        name: macos-nodejs
        path: artifacts/
  macos_electron:
    name: Macos Electron build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-node@v1
      with:
        node-version: '12'
    - name: Setup npm environment
      run: |
        npm install -g npm
        # https://github.com/mapbox/node-pre-gyp/issues/362
        npm install -g node-gyp@3
    - name: Build
      env:
        JOBS: '8'
      run: |
        export ARTIFACTS_OUT=$GITHUB_WORKSPACE/artifacts
        packages/grpc-native-core/tools/run_tests/artifacts/build_artifact_electron.sh
    - uses: actions/upload-artifact@v2
      with:
        name: macos-electron
        path: artifacts/
  windows_nodejs:
    name: Windows Node build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-node@v1
      with:
        node-version: '12'
    - uses: microsoft/setup-msbuild@v1.0.0
    - name: Setup npm environment
      run: |
        npm install -g npm@6.10.x
        # https://github.com/mapbox/node-pre-gyp/issues/362
        npm install -g node-gyp@3
    - name: Build
      env:
        ARTIFACTS_OUT: '%GITHUB_WORKSPACE%/artifacts'
      run: tools/release/kokoro-electron.bat
    - uses: actions/upload-artifact@v2
      with:
        name: windows-nodejs
        path: artifacts/
  windows_electron:
    name: Windows Electron build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: actions/setup-node@v1
      with:
        node-version: '12'
    - uses: microsoft/setup-msbuild@v1.0.0
    - name: Setup npm environment
      run: |
        npm install -g npm@6.10.x
        # https://github.com/mapbox/node-pre-gyp/issues/362
        npm install -g node-gyp@3
    - name: Build
      env:
        ARTIFACTS_OUT: '%GITHUB_WORKSPACE%/artifacts'
      run: tools/release/kokoro-electron.bat
    - uses: actions/upload-artifact@v2
      with:
        name: windows-electron
        path: artifacts/
  combine_artifacts:
    name: Combine Artifacts
    runs-on: ubuntu-latest
    needs: [linux_nodejs_native, linux_nodejs_alpine, linux_nodejs_arm, linux_electron, macos_nodejs, macos_electron, windows_nodejs, windows_electron]
    steps:
    - uses: actions/download-artifact@v2
    - name: Copy
      run: |
        mkdir artifacts
        cp -r ./**/* artifacts/
    - uses: actions/upload-artifact@v2
      with:
        name: combined-artifacts
        path: artifacts/